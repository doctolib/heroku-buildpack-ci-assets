#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e # fail fast

BUILD_DIR=$1
CACHE_DIR=$2

printenv

mkdir -p $CACHE_DIR

cd $BUILD_DIR

HASH=$(bin/hash_asset_dependencies)

if [ -d $CACHE_DIR/assets-$HASH ]; then
 cp -r $CACHE_DIR/assets-$HASH/assets $BUILD_DIR/public/assets
 cp -r $CACHE_DIR/assets-$HASH/webpack $BUILD_DIR/public/webpack
else
  date +"%T"
  npm run build:dev:local
  date +"%T"
  rake assets:precompile
  date +"%T"
  cp -r $BUILD_DIR/public/assets $CACHE_DIR/assets-$HASH/assets 
  cp -r $BUILD_DIR/public/webpack $CACHE_DIR/assets-$HASH/webpack
fi

# pruning the cache ?
# remove { "url": "heroku/nodejs" } and install node and packages in the else branch ?
