#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

indent() {
  sed -u 's/^/       /'
}
set -e # fail fast

BUILD_DIR=$1
CACHE_DIR=$2

mkdir -p $CACHE_DIR

cd $CACHE_DIR/..
ls
cat HEAD
REF=`cat HEAD | awk '{ print $2 }'`
HEROKU_TEST_RUN_COMMIT_VERSION=`cat $REF`
echo "HEROKU_TEST_RUN_COMMIT_VERSION $HEROKU_TEST_RUN_COMMIT_VERSION"

cd $BUILD_DIR
HASH=$(bin/hash_asset_dependencies)

if [ -d $CACHE_DIR/assets-$HASH ]; then
  echo "Copying cached assets for hash $HASH" | indent
  cp -r $CACHE_DIR/assets-$HASH/assets $BUILD_DIR/public/assets
  cp -r $CACHE_DIR/assets-$HASH/webpack $BUILD_DIR/public/webpack
else
  echo "No assets in cache for hash $HASH" | indent
  date +"%T"
  cd $GIT_DIR
  export HEROKU_TEST_RUN_COMMIT_VERSION
  cd $BUILD_DIR
  npm run build:dev:local | indent
  date +"%T"
  source $BUILD_DIR/.profile.d/ruby.sh
  rake assets:precompile | indent
  date +"%T"
  mkdir $CACHE_DIR/assets-$HASH
  cp -r $BUILD_DIR/public/assets $CACHE_DIR/assets-$HASH
  cp -r $BUILD_DIR/public/webpack $CACHE_DIR/assets-$HASH
fi

# pruning the cache ?
# remove { "url": "heroku/nodejs" } and install node and packages in the else branch ?
