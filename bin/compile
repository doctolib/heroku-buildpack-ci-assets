#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

indent() {
  sed -u 's/^/       /'
}
set -e # fail fast

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

mkdir -p $CACHE_DIR

cd $BUILD_DIR
HASH=$(bin/hash_asset_dependencies)
ASSETS_CACHE_DIR=$CACHE_DIR/assets-$HASH

if [ -d $ASSETS_CACHE_DIR ]; then
  echo "Copying cached assets for hash $HASH" | indent
  du -h --max-depth=1 $CACHE_DIR
  cp -r $ASSETS_CACHE_DIR/ $BUILD_DIR/public
else
  echo "No assets in cache for hash $HASH" | indent
  date +"%T"
  export HEROKU_TEST_RUN_COMMIT_VERSION=`cat $ENV_DIR/HEROKU_TEST_RUN_COMMIT_VERSION`
  npm run build:dev:local | indent
  date +"%T"
  source $BUILD_DIR/.profile.d/ruby.sh
  rake assets:precompile | indent
  date +"%T"
  mkdir $ASSETS_CACHE_DIR
  cp -r $BUILD_DIR/public/assets $ASSETS_CACHE_DIR
  cp -r $BUILD_DIR/public/webpack $ASSETS_CACHE_DIR
fi
echo `date +"%F %T"` > $ASSETS_CACHE_DIR/last_use

ruby prune_cache.rb $CACHE_DIR
